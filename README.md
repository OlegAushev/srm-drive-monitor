# Установка
**Системные требования**: 
* Ubuntu 20.04 и выше
* Установленные библиотеки Qt5:
```
$ sudo apt install libqt5charts5 libqt5qml5 qml-module-qtquick2 qml-module-qtquick-controls2 qml-module-qtquick-layouts qml-module-qtquick-window2 qml-module-qtcharts qml-module-qtquick-dialogs qml-module-qtquick-extras qml-module-qtquick-controls
``` 
* Папку `srm-drive-monitor` поместить в каталог `/home/<user>`.  
* Файлам `srm-drive-monitor` и `connect_can.sh` установить разрешение на выполенение как программам.
* *Необязательно*. Для добавления иконки запуска в панель приложений в файле `srm-drive-monitor.desktop` заменить $USER на имя пользователя и поместить указанный файл в каталог `home/<user>/.local/share/applications`. Перезапустить окружение рабочего стола, по умолчанию: `Alt+F2`, выполнить `r`.

# Запуск

```
$ cd <расположение srm-drive-monitor>
$ ./srm-drive-monitor
```

Для подключения к CAN-шине: *Connect CAN Device* &rarr; *can0*, в появившемся файловом диалоге выбрать скрипт `connect_can.sh`.

# Описание интерфейса

## 1. Область меню

### App

**Device Name** - выводит название подключённого преобразователя (по умолчанию - *SRMD*).

**Software Version** - выводит версию прошивки подключённого преобразователя.

**Software Build Configuration** - выводит название конфигурации сборки прошивки подключённого преобразователя (*REVA*, *REVB* и т.д.).

### Network

**Connect CAN Device** - подключение к CAN-шине (необходимо выбрать интерфейс *can0*, в появившемся файловом диалоге выбрать скрипт `connect_can.sh`).

**Disconnect CAN Device** - отключение от CAN-шины.

**Watch Requests** - меню настройки частоты отправки *SDO*-запросов (*CAN ID* 0x601/0x581) вспомогательной диагностической информации, которая выводится в таблице *Watch*.

### Drive
**Reset Faults** - сброс ошибок и предупреждений.

**Calibrate Position Sensor** - калибровка датчика положения ротора. **ВНИМАНИЕ!** Данная операция сопряжена с вращением ротора двигателя, поэтому перед началом данной операции должно быть обеспечено вывешенное состояние ведущих колёс.

**Invert Rotation Direction** - изменить "положительное" направление вращения двигателя. Изначально за "положительное" направление вращения двигателя принимается то направление, в котором осуществляется калибровка датчика положения ротора. "Положительное" направление вращения двигателя должно приводить к направлению вращения колёс автомобиля, соответсвующему движению автомобиля вперёд.

**Set Reference** - установить тип управляющего задания: скорость (*Speed*) или момент (*Torque*).

**Reset Device** - перезагрузить преобразователь. 

## 2. Область панели упавления

**TLC Emulation On/Off** - вкл/выкл эмуляцию КВУ посредством генерирования управляющих *PDO*-сообщений (*CAN ID* 0x194, 0x294).

**Power On/Off** - подключение преобразователя к батарее (переключение между режимами *STANDBY* и *READY*).

**Motor Run On/Off** - перевод преобразователя в режим реализации задания скорости/момента (переключение между режимами *READY* и *IN_OPERATION*).

**Emergency On/Off** - аварийный останов.

## 3. Левая рабочая область

### DATA

Содержит таблицы данных, получаемых посредством *SDO*-запросов (таблица *WATCH*) и *PDO*-сообщений (таблицы *TDPO1..4*), и окно лога.

### INFO

Содержит информацию о текущем состоянии преобразователя - ошибках и предупреждениях.

### CHARTS

Содержит области отображения графиков различных величин в реальном времени.

## 4. Правая рабочая область

### CONTROL

**Speed** - задание скорости.

**Torque** - задание момента.

**Field Current** - не используется.

**Gamma Correction** - не используется.

Индикатор в правом верхнем углу каждого органа управления обозначает его активность, т.е. формирует ли орган управления в данный момент времени соответствующий сигнал задания для преобразователя.

### CONFIGURATION

Область конфигурации параметров преобразователя, хранимых в его EEPROM. После записи параметров (кнопка **WRITE**) необходимо осуществить их применение путём нажатия на кнопку **APPLY**. Возврат к значениям по умолчанию возможен путём нажатия на кнопку **RESET TO DEFAULT**. Конфигурирование преобразователя требуется производить в режиме *STANDBY*. Чтение параметров (кнопка **READ**) возможно в любом режиме работы преобразователя.

# Перечень параметров преобразователя и их значений по умолчанию

## Двигатель

| Название                                        | Обозначение     | Значение | Ед. изм. |
| ----------------------------------------------- | --------------- | -------- | -------- |
| Уставка защиты от перегрева двигателя           | OTP_STATOR      | 175      | °C       |
| Уставка защиты от перегрева обмотки возбуждения | OTP_FW          | 175      | °C       |
| Температура включения вентилятора               | FAN_TEMP_TH_ON  | 80       | °C       |
| Температура выключения вентилятора              | FAN_TEMP_TH_OFF | 70       | °C       |

## Модель 

| Название                                                                       | Обозначение     | Значение     | Ед. изм. |
| ------------------------------------------------------------------------------ | --------------- | ------------ | -------- |
| Тип управляющего задания (n - скорость, M - момент)                            | REFERENCE       | 0 — n, 1 — M |
| Коэффициент усиления пропорциональной составляющей регулятора скорости         | KP_SPEED        | 0,2          |
| Коэффициент усиления интегрирующей составляющей регулятора скорости            | KI_SPEED        | 0,00001      |
| Коэффициент усиления пропорциональной составляющей регулятора тока Id          | KP_ID           | 2,2          |
| Коэффициент усиления интегрирующей составляющей регулятора тока Id             | KI_ID           | 0,022        |
| Коэффициент усиления пропорциональной составляющей регулятора тока Iq          | KP_IQ           | 1,1          |
| Коэффициент усиления интегрирующей составляющей регулятора тока Iq             | KI_IQ           | 0,011        |
| Коэффициент усиления пропорциональной составляющей регулятора тока возбуждения | KP_IF           | 50           |
| Коэффициент усиления интегрирующей составляющей регулятора тока возбуждения    | KI_IF           | 0,05         |
| Максимальный ток двигателя в двигательном режиме                               | IS_MOTOR_MAX    | 270          | А        |
| Максимальный ток двигателя в режиме торможения                                 | IS_GENER_MAX    | 270          | А        |
| Максимальный ток возбуждения                                                   | IF_MAX          | 30           | А        |
| Максимальный момент в положительном направлении                                | TORQUE_POS_MAX  | 140          | Нм       |
| Максимальный момент в отрицательном направлении                                | TORQUE_NEG_MAX  | 140          | Нм       |
| Максимальная скорость                                                          | SPEED_MAX       | 8000         | об/мин   |
| Коэффициент усиления пропорциональной составляющей регулятора ослабления поля  | KP_FLUXWEAK     | 1            |
| Коэффициент усиления интегрирующей составляющей регулятора ослабления поля     | KI_FLUXWEAK     | 10           |
| Ограничение выхода регулятора ослабления поля                                  | ID_MAX_FLUXWEAK | 75           | А        |

## Инвертор

| Название                                      | Обозначение     | Значение | Ед. изм. |
| --------------------------------------------- | --------------- | -------- | -------- |
| Уставка защиты от понижения напряжения в ЗПТ  | UVP_DC          | 280      | В        |
| Уставка защиты от повышения напряжения в ЗПТ  | OVP_DC          | 450      | В        |
| Уставка защиты от превышения фазного тока     | OCP_PHASE       | 320      | А        |
| Уставка защиты от превышения тока возбуждения | OCP_FIELD       | 100      | А        |
| Уставка защиты от перегрева ключей            | OTP_JUNCTION    | 105      | °C       |
| Уставка защиты от перегрева инвертора         | OTP_AIR         | 90       | °C       |
| Температура включения вентилятора             | FAN_TEMP_TH_ON  | 65       | °C       |
| Температура выключения вентилятора            | FAN_TEMP_TH_OFF | 55       | °C       |

## Контакторы

| Название                                                                                            | Обозначение                | Значение | Ед. изм. |
| --------------------------------------------------------------------------------------------------- | -------------------------- | -------- | -------- |
| Напряжение срабатывания основного контактора                                                        | DCLINK_CHARGE_THRESHOLD    | 320      | В        |
| Максимальное время ожидания нарастания напряжения в ЗПТ до уровня срабатывания основного контактора | DCLINK_CHARGE_TIMEOUT      | 1000     | мс       |
| Время выдержки от срабатывания основного контактора до отключения зарядного контактора              | DCLINK_CONTACTOR_HOLDUP    | 2000     | мс       |
| Пороговое напряжение шины постоянного тока при отключении                                           | DCLINK_DISCHARGE_THRESHOLD | 300      | В        |
| Время ожидания снижения напряжения до порогового уровня при отключении                              | DCLINK_DISCHARGE_TIMEOUT   | 5000     | мс       |

# Процедура прошивки микроконтроллера посредством утилиты *UniFlash*

1. Подключить программатор к микроконтроллерной плате и ПК.
2. Подать питание 24В на микроконтроллерную плату.
3. Запустить утилиту *UniFlash*.
4. В меню **Choose Your Device** выбрать *TMS320F28377D*.
5. В меню **Choose Your Connection** выбрать *Texas Instruments XDS100v3 USB Debug Probe*.
6. Нажать **Start**.
7. **Program** &rarr; **C28xx_CPU1** &rarr; **Flash Image(s)** &rarr; **Browse** &rarr; выбрать файл прошивки `srm-drive-c28x-cpu1.out`.
8. Нажать **Load Image**.
9. Дождаться окончания.
10. **Program** &rarr; **C28xx_CPU2** &rarr; **Flash Image(s)** &rarr; **Browse** &rarr; выбрать файл прошивки `srm-drive-c28x-cpu2.out`.
11. Нажать **Load Image**.
12. Дождаться окончания.
13. Снять питание с микроконтроллерной платы.
14. Отключить программатор.

# Процедура первого запуска преобразователся

1. Подключить *CAN*-адаптер к преобразователю и ПК.
2. Запустить программу **SRM Drive Monitor**, подключиться к *CAN*-шине, включить режим эмуляции КВУ.
3. Включить питание преобразователя. Должны появиться данные в таблице *WATCH* (если *SDO*-запросы не отключены).
4. Произвести сброс преобразователя к настройкам по умолчанию: **CONFIGURATION** &rarr; **RESET TO DEFAULT**. В окне лога должны появиться сообщения об успехе операции, преобразователь дожлен перезагрузиться, и должны появиться данные *PDO*-сообщений.
5. Проверить отсутствие ошибок.
6. Наиболее простым способом проверки работоспособности преобразователя является запуск процедуры калибровки датчика положения ротора подключённого к преобразователю двигателя. Для этого параметры *UVP_DC* и *DCLINK_CHARGE_THRESHOLD* требуется установить на уровне ниже напряжения аккумуляторной батареи: ~0.8*Vbatt* и ~0.9..0.95*Vbatt* соответственно (**WRITE** &rarr; **APPLY**).
7. Запустить калибровку: **Drive** &rarr; **Calibrate Position Sensor**.
8. После успешной калибровки преобразователь готов к реализации задания момента/скорости.